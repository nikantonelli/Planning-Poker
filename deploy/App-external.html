<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Niks.Apps.PlanningGame",{extend:"Rally.app.App",componentCls:"app",itemId:"pokerApp",_GC:{},config:{configFieldName:"c_PlanningPokerConfig",configSplitter:"^",showVotePanel:!1},statics:{SAVE_FAIL_RETRIES:5},listeners:{removeGame:function(){var e=[];_.each(Object.keys(pokerMsg),function(t){e.push({property:"Text",operator:"contains",value:pokerMsg[t]})});var t=this;Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Clean up from game",message:"Remove all game generated posts?",confirmLabel:"Yes",listeners:{confirm:function(){Ext.create("Rally.data.wsapi.Store",{model:"ConversationPost",filters:Rally.data.wsapi.Filter.or(e),autoLoad:!0,context:t.getContext().getDataContext(),listeners:{load:function(e,o,i){var r=o.length,s=[];i&&(_.each(o,function(e){s.push(e.destroy())}),Deft.Promise.all(s).then({success:function(){Rally.ui.notify.Notifier.showWarning({message:Ext.String.format(" {0} Records Deleted",r)}),t._reloadGame()}}))}}})}}})},switchpanel:function(){this.showVotePanel?(this.showVotePanel=!1,this.userPage.hide(),this.modPage.show()):(this.showVotePanel=!0,this.userPage.show(),this.modPage.hide())},adduser:function(e){this._MC.addExtraUser(e),this._GC.addExtraUser(e)},removeuser:function(e){this._MC.removeExtraUser(e),this._GC.removeExtraUser(e)},configsaver:function(){this._saveProjectConfig()},configchanged:function(){var e=this;this._saveProjectConfig().then({success:function(t){e._GC.initialiseConfig(t),e._UC.setConfig(e._GC.getNamedConfig(userConfigName)),e._MC.setConfig(e._GC.getNamedConfig(userConfigName)),e._IC.setConfig(e._GC.getNamedConfig(iterConfigName)),this._reloadGame()},failure:function(e){console.log("Failed to save project config",e)},scope:this})},refresh:function(){Rally.ui.notify.Notifier.show({message:"Refreshing Game"}),this._startGame()},showConfig:function(){this._iAmModerator()&&this._GC.showPanel()},changeIteration:function(){this._iAmModerator()&&this._IC.showPanel()},cardselected:function(e){console.log("cardselected: ",e),this._UC.selectCard(e,this._GC.getNamedConfig(mainConfigName)),this._iAmModerator()&&this._MC.selectCard(e,this._GC.getNamedConfig(mainConfigName)),this._storySelected=e},voteselected:function(e){this._voteSelected=e,this._UC.setVote(e)},postvote:function(){var e=this;this._voteSelected&&this._storySelected&&Rally.data.ModelFactory.getModel({type:"ConversationPost",success:function(t){Ext.create(t,{Text:"<p>"+pokerMsg.votePosted+":"+JSON.stringify(e._voteSelected)+"</p>",Artifact:e._storySelected.story.get("_ref")}).save({callback:function(t,o){o.wasSuccessful()?(Rally.ui.notify.Notifier.show({message:Ext.String.format("Vote Posted on {0} was {1}",e._storySelected.story.get("FormattedID"),e.getSetting("useTShirt")?e._voteSelected.size:e._voteSelected.value)}),e._UC.postedVote(e._storySelected)):Rally.ui.notify.Notifier.showWarning({message:"Failed to post vote. Please retry"})}})}})}},_voteSelected:null,_storySelected:null,_processStoryChanges:function(){this._reloadGame()},_reloadGame:function(){this._kickOff()},_iAmModerator:function(){return this.getContext().getUser().ObjectID===this._GC.getModerator().get("ObjectID")},_setUpUserScreen:function(){var e=this._iAmModerator();if(e){this.modPage=this._MC.restart(!0),this._MC.addSwitch(),this.modPage.show(),this.userPage=this._UC.restart(!1),this._UC.addSwitch(),this.userPage.hide();this._GC.getConfigValue("allowIterationSelector")?this._MC.enableIterationButton():this._MC.disableIterationButton()}else this.userPage=this._UC.restart(!1),this.userPage.show();this._storyStore&&(e&&this._MC.loadStories(this._storyStore.getRecords()),this._UC.loadStories(this._storyStore.getRecords()))},_getStoryStore:function(e){var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:this._GC.getConfigValue("artefactTypes"),context:this.getContext().getDataContext(),autoLoad:!0,pageSize:storyFetchLimit,limit:storyFetchLimit,sorters:[{property:"DragAndDropRank",dir:"DESC"}],fetch:["FormattedID","TargetDate","Description","Discussion","LatestDiscussionAgeInMinutes","LastUpdateDate","Name","State","ScheduleState","Owner","PlanEstimate"],filters:e,listeners:{load:function(e,o,i){i?(storeLoadTime=new Date,Rally.ui.notify.Notifier.show({message:Ext.String.format("Loaded {0} stories",o.length)}),t.resolve(e)):(Rally.ui.notify.Notifier.showWarning({message:"No stories found in this iteration/project node"}),t.reject(null))},scope:this}}),t.promise},_kickOff:function(){var e=this;e._IC.getCurrentIteration().then({success:function(t){var o=[],i=e._GC.getConfigValue("storyFilter");i&&o.push(Rally.data.wsapi.Filter.fromQueryString(i)),e._GC.getConfigValue("allowIterationSelector")&&o.push({property:"Iteration",value:t}),o=Rally.data.wsapi.Filter.and(o)||[],e._getStoryStore(o).then({success:function(t){e._storyStore=t},failure:function(e){console.log("Fatal failure to load stories. Clean out the project config and start again",e)}}).always(function(){e._setUpUserScreen()})},failure:function(e){console.log("Didn't find a 'current' iteration",e)}})},_loadGameConfig:function(){var e=this;if(this._UC.useTShirtSizing(this._GC.getConfigValue("useTShirt")),this._iAmModerator()){this._MC.useTShirtSizing(this._GC.getConfigValue("useTShirt"));var t=[this._loadTeamMembers];t.push(this._loadExtraUsers),Deft.Chain.parallel(t,e).then({success:function(t){_.each(t[0],function(t){console.log("Adding user: ",t),e._MC.addUser(t)}),_.each(t[1],function(t){console.log("Adding user: ",t),e._MC.addExtraUser(t),e._GC.addExtraUser(t)})},failure:function(e){Rally.ui.nofity.Notifier.showError({message:e})}}).always(function(t){e._kickOff()})}else e._kickOff()},_loadExtraUsers:function(){var e=Ext.create("Deft.Deferred"),t=this._GC.getConfigValue("extraUsers")||[];if(!t.length)return e.resolve([]),e.promise;var o=[{property:"Disabled",value:!1},{property:userIdField,operator:"in",value:_.pluck(t,"userOID")}];return Ext.create("Rally.data.wsapi.Store",{model:"User",fetch:!0,autoLoad:!0,filters:o,listeners:{load:function(t,o,i){!0===i?(Rally.ui.notify.Notifier.show({message:"Extra Users loaded"}),e.resolve(o)):(console.log("Extra Users unavailable"),e.reject("Extra Users unavailable"))},scope:this}}),e.promise},_loadTeamMembers:function(){var e=Ext.create("Deft.Deferred"),t=this.projectStore.getRecords()[0];return t.get("TeamMembers").Count>0?t.getCollection("TeamMembers").load({fetch:!0,filters:[{property:"Disabled",value:!1}],callback:function(t,o,i){!0===i?(Rally.ui.notify.Notifier.show({message:"Team members loaded"}),e.resolve(t)):(console.log("Team members field unavailable"),e.reject("Team members field unavailable"))},scope:this}):(Rally.ui.notify.Notifier.showWarning({message:"Team members not configured"}),e.reject(null,"No Team Members")),e.promise},launch:function(){var e=this;e._GC=Ext.create("Niks.Apps.PokerGameConfig",{app:e,project:e.getContext().getProject()}),e._UC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),e._MC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),e._IC=Ext.create("Niks.Apps.PokerIterationConfig",{app:e,project:e.getContext().getProject()}),this._startGame()},_startGame:function(){var e=this;this._checkProjectFieldConfig().then({success:function(){this._getProjectConfig().then({success:function(t){t.hasOwnProperty("moderatorID")?e._GC.setModeratorFromId(t.moderatorID).then({success:function(){e._loadGameConfig()},failure:function(){console.log("Failed to set moderator from ID")}}):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Config",message:"Are you moderator for this session?",listeners:{confirm:function(){e._GC.setModeratorFromId(e.getContext().getUser()[userIdField]).then({success:function(){e._saveProjectConfig().then({success:function(){e._loadGameConfig()},failure:function(e){console.log("Failed to save project config",e)},scope:e})}})}}})},failure:function(e){Rally.ui.notify.Notifier.showWarning({message:e}),console.log(e)},scope:e})},failure:function(e){Rally.ui.notify.Notifier.showWarning({message:e}),console.log(e)},scope:e})},_createStoryBrowser:function(){return Ext.create("Deft.Deferred").promise},_createUserMenu:function(){return Ext.create("Deft.Deferred").promise},_createLeadMenu:function(){return Ext.create("Deft.Deferred").promise},_checkProjectFieldConfig:function(){var e=this,t=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Project",fetch:!0,success:function(o){o.hasField(e.configFieldName)&&"string"===o.getField(e.configFieldName).type.type?t.resolve(o):t.reject("Correct Config on Project artefact not available")},failure:function(){t.reject("Failed to get Project Model")}}),t.promise},_getProjectConfig:function(){var e=this,t=Ext.create("Deft.Deferred"),o=this.getContext().getProject();return e.projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",filters:[{property:"ObjectID",value:o.ObjectID}],autoLoad:!0,fetch:!0,listeners:{load:function(o,i){e._GC.initialiseConfig(i[0].get(this.configFieldName)),e._UC.setConfig(e._GC.getNamedConfig(userConfigName)),e._MC.setConfig(e._GC.getNamedConfig(userConfigName)),e._IC.setConfig(e._GC.getNamedConfig(iterConfigName));var r=e._GC.getNamedConfig(mainConfigName);t.resolve(r)},scope:e}}),t.promise},_failedSave:0,_saveProjectConfig:function(e){this._GC.updateNamedConfig(iterConfigName,this._IC.getConfig()),this._GC.updateNamedConfig(userConfigName,this._MC.getConfig());var t=void 0===e?Ext.create("Deft.Deferred"):e,o=this._GC.getGameConfig(),i=this.projectStore.getRecords()[0];return i.set(this.configFieldName,o),i.save({success:function(){this._failedSave=0,Rally.ui.notify.Notifier.show({message:"Config Saved to Project"}),t.resolve(o)},failure:function(){this._failedSave<this.self.SAVE_FAIL_RETRIES?this._saveProjectConfig(t):t.reject("Failed to save Project Config")},scope:this}),t.promise},_checkConfigChange:function(e){console.log(e)},_createConfigPage:function(){return Ext.create("Deft.Deferred").promise},_createUserPage:function(){return Ext.create("Deft.Deferred").promise},_createLeadPage:function(){return Ext.create("Deft.Deferred").promise}});
                const modChange="moderatorchanged",configChange="configchanged",configSave="configsaver",mainConfigName="MainConfig",userConfigName="UserConfig",iterConfigName="IterConfig",cardWidth=400,cardHeight=300,cardMargin=10,cardSizeField="PlanEstimate",cardIdField="FormattedID",configSplitter1="^",configSplitter2="|",votingTime="00:10",userIdField="ObjectID",storyFetchLimit=50,pokerMsg={votePosted:"POKER_VOTE_POSTED"},valueSeries=[{size:"XS",value:1},{size:"S",value:2},{size:"M",value:3},{size:"L",value:5},{size:"XL",value:8},{size:"XXL",value:13},{size:"XXXL",value:20},{size:"Too Big",value:40}];
                Ext.define("Niks.Apps.Panel",{bubbleEvents:[],constructor:function(n){this.users=[],Ext.applyIf(this,n)},getPanel:function(n){return this.configPanel||this._createPanel(n)},showPanel:function(){this.getPanel().show()},hidePanel:function(){this.getPanel().hide()},destroyPanel:function(){this.configPanel&&(this.getPanel().destroy(),this.configPanel=null)}});
                Ext.define("Niks.Apps.PokerGameConfig",{extend:Niks.Apps.Panel,id:mainConfigName+"Panel",userIDs:[],moderatorUser:null,initialiseConfig:function(e){this[mainConfigName]=this._decodeConfig(mainConfigName,e),this[userConfigName]=this._decodeConfig(userConfigName,e),this[iterConfigName]=this._decodeConfig(iterConfigName,e),this[mainConfigName].votingTime||(this[mainConfigName].votingTime=votingTime),this[mainConfigName].artefactTypes&&this[mainConfigName].artefactTypes.length||(this[mainConfigName].artefactTypes=["UserStory","Defect"]),this[mainConfigName].extraUsers=this[mainConfigName].extraUsers||[]},getNamedConfig:function(e){return this[e]||{}},updateNamedConfig:function(e,t){this[e]=t},_decodeConfig:function(e,t){if(void 0===t||0===t.length)return{};var i=t.split(configSplitter1),a={};return _.each(i,function(e){var t=e.split(configSplitter2);t[0].length&&(a[t[0]]=t[1])}),JSON.parse(a[e]||"{}")},addUser:function(e){_.find(this.userIDs,{userOID:e.get(userIdField)})?console.log("Adding existing member - ignoring!"):this.userIDs.push(e[userIdField])},addExtraUser:function(e){_.find(this[mainConfigName].extraUsers,{userOID:e.get(userIdField)})?console.log("Adding existing member - ignoring!"):this[mainConfigName].extraUsers.push({userOID:e.get(userIdField),displayName:e.get("DisplayName")}),this._updateCurrentUserList()},removeExtraUser:function(e){storedUser=_.find(this[mainConfigName].extraUsers,{userOID:e.get(userIdField)}),storedUser?this[mainConfigName].extraUsers=_.without(this[mainConfigName].extraUsers,storedUser):console.log("Removing non-existent member - ignoring!"),this._updateCurrentUserList()},getModerator:function(){return this.moderatorUser?this.moderatorUser:null},setModerator:function(e){console.log("mod set to:",e),this[mainConfigName].moderatorID=e.get(userIdField),this.moderatorUser=e},setModeratorFromId:function(e){var t=this,i=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,filters:[{property:userIdField,value:e}],listeners:{load:function(e,a,n){n?(t.setModerator(a[0]),i.resolve(a[0])):i.reject()}}}),i.promise},getConfigValue:function(e){return this[mainConfigName][e]},_encodeMsg:function(e,t){return configSplitter1+e+configSplitter2+t},_decodeMsg:function(e,t){return t.split(configSplitter2).pop()},getGameConfig:function(){return this._encodeMsg(mainConfigName,JSON.stringify(this[mainConfigName]))+this._encodeMsg(userConfigName,JSON.stringify(this[userConfigName]))+this._encodeMsg(iterConfigName,JSON.stringify(this[iterConfigName]))},_getCurrentUserList:function(){var e="";return _.each(this.getConfigValue("extraUsers"),function(t){e+=t.displayName+","}),e},_updateCurrentUserList:function(){this.getPanel().down("#extrauserlist").setValue(this._getCurrentUserList()),this.app.fireEvent(configChange)},_createPanel:function(){var e=this,t=Ext.create("Ext.panel.Panel",{floating:!0,draggable:!0,width:500,height:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return t.add({xtype:"field",id:"curMod",fieldLabel:"Current Moderator",labelWidth:180,width:460,margin:"10 0 5 20",baseBodyCls:"textfield",readOnly:!0,value:e.moderatorUser?e.moderatorUser.get("UserName"):"Not Set"}),t.add({xtype:"rallyusercombobox",id:"modChooser",fieldLabel:"Change Moderator To",valueField:userIdField,labelWidth:180,width:460,margin:"5 0 5 20",autoSelect:!1,listeners:{select:function(i){null!==i.value&&(e.setModerator(i.lastSelection[0]),t.down("#curMod").setValue(e.moderatorUser.get("UserName")),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Moderator",message:"Restart session?",listeners:{confirm:function(){e.app.fireEvent(configChange),e.hidePanel()}}}))}}}),t.add({xtype:"rallycheckboxfield",fieldLabel:"Enable Iteration Selector",id:"allowIterationSelector",value:e[mainConfigName].allowIterationSelector,labelWidth:180,margin:"5 0 0 20",listeners:{change:function(t,i,a,n){e[mainConfigName].allowIterationSelector=i,e.app.fireEvent(configChange)}}}),t.add({xtype:"rallycheckboxfield",fieldLabel:"Use T-Shirt sizing",id:"useTShirt",value:e[mainConfigName].useTShirt,labelWidth:180,margin:"5 0 0 20",listeners:{change:function(t,i,a,n){e[mainConfigName].useTShirt=i,e[userConfigName].useTShirt=i,e.app.fireEvent(configChange)}}}),t.add({xtype:"textfield",baseCls:"timerText",fieldLabel:"Voting Time (min:sec)",labelWidth:180,margin:"5 0 5 20",value:e[mainConfigName].votingTime||votingTime,validator:function(t){return void 0!==Ext.Date.parse(t,"i:s")&&(e[mainConfigName].votingTime=t,e.app.fireEvent(configSave),!0)}}),t.add({xtype:"container",margin:"5 0 5 20",layout:"hbox",items:[{xtype:"rallycheckboxfield",itemId:"selectStories",fieldLabel:"Stories",labelWidth:80,labelAlign:"right",margin:"0 60 0 0",listeners:{change:function(t,i){i?e[mainConfigName].artefactTypes=_.union(e[mainConfigName].artefactTypes,["UserStory"]):(e[mainConfigName].artefactTypes=_.without(e[mainConfigName].artefactTypes,"UserStory"),!1===e.getPanel().down("#selectDefects").getValue()&&e.getPanel().down("#selectDefects").setValue(!0)),e.app.fireEvent(configChange)}},value:_.indexOf(e[mainConfigName].artefactTypes,"UserStory")>=0},{xtype:"rallycheckboxfield",fieldLabel:"Defects",labelWidth:80,labelAlign:"right",itemId:"selectDefects",margin:0,listeners:{change:function(t,i){i?e[mainConfigName].artefactTypes=_.union(e[mainConfigName].artefactTypes,["Defect"]):(e[mainConfigName].artefactTypes=_.without(e[mainConfigName].artefactTypes,"Defect"),!1===e.getPanel().down("#selectStories").getValue()&&e.getPanel().down("#selectStories").setValue(!0)),e.app.fireEvent(configChange)}},value:_.indexOf(e[mainConfigName].artefactTypes,"Defect")>=0}]}),t.add({xtype:"textarea",fieldLabel:"Artefact Filter",name:"query",cls:"query-field",labelAlign:"top",width:460,value:e[mainConfigName].storyFilter,margin:"0 20 5 20",validateOnBlur:!0,validateOnChange:!1,validator:function(t){try{return t&&Rally.data.wsapi.Filter.fromQueryString(t),e[mainConfigName].storyFilter=t,e.app.fireEvent(configChange),!0}catch(e){return e.message}}}),t.add({xtype:"container",layout:"hbox",items:[{margin:"0 5 5 20",fieldLabel:"Extra User",labelWidth:60,width:280,xtype:"rallyusersearchcombobox",itemId:"usersearchbox",storeConfig:{fetch:!0},listeners:{select:function(e,i){t.down("#addUserButton").enable(),t.down("#delUserButton").enable()}}},{xtype:"rallybutton",text:"Add",itemId:"addUserButton",disabled:!0,width:80,margin:"0 5 5 5",handler:function(){e.app.fireEvent("adduser",t.down("#usersearchbox").getRecord())}},{xtype:"rallybutton",text:"Remove",itemId:"delUserButton",width:80,disabled:!0,margin:"0 5 5 5",handler:function(){e.app.fireEvent("removeuser",t.down("#usersearchbox").getRecord())}}]}),t.add({xtype:"textarea",fieldLabel:"Extra User List",itemId:"extrauserlist",labelAlign:"top",width:460,value:e._getCurrentUserList(),margin:"0 20 5 20",readOnly:!0}),this.configPanel=t,t}});
                Ext.define("Niks.Apps.PokerCard",{extend:Ext.panel.Panel,margin:cardMargin,layout:{type:"vbox",align:"left"},autoScroll:!0,config:{story:null,voteSize:null},applyVoteSize:function(t){this.voteSize=t;var e=this,i=Ext.create("Rally.ui.Button",{margin:10,disabled:!0,text:(t.tshirt?t.size:t.value).toString(),cls:"buttontext",width:this.width-22,height:this.height-22,handler:function(){this.up("#pokerApp").fireEvent("voteselected",e.voteSize)}});this.add(i)},postedVote:function(){this.voted=this.vote,this.setVoteString()},setVoteString:function(t){t&&t!==this.vote&&(this.vote=t),t&&t!==this.vote||this.vote!==this.voted?(this.tf.removeCls("definedfield"),this.tf.addCls("erroredfield")):(this.tf.addCls("definedfield"),this.tf.removeCls("erroredfield"));var e=this.story.get(cardSizeField);e=null===e?0===e?"set to zero":"not set":e.toString(),this.tf.update(Ext.String.format("Current Size: {0} {1} {2}",e,this.vote?" - You chose: "+(this.vote.tshirt?this.vote.size:this.vote.value):"",this.voted?" and have voted: "+(this.voted.tshirt?this.voted.size:this.voted.value):""))},applyStory:function(t){this.story=t,this.tf=Ext.create("Ext.form.field.Text",{xtype:"textfield",itemId:"sizeText"+t.get(cardIdField),width:cardWidth-30,margin:"5 0 5 10",cls:"definedfield"}),this.add(this.tf),this.setVoteString();var e=t.get("Description");e=e.length?e:"<p>Description field Empty</p><p><b>Please go to Artefact and enter a Description of the Required Effort</b></p>";var i=Ext.create("Ext.form.Label",{margin:cardMargin,forId:"sizeText"+t.get(cardIdField),width:cardWidth-40,grow:!0,hideLabel:!0,readOnly:!0,autoScroll:!0,html:e});this.add(i),this.getEl().on("click",function(t,e){"A"!==e.nodeName&&this.up("#pokerApp").fireEvent("cardselected",this)},this)}});
                Ext.define("Niks.Apps.PokerUserConfig",{extend:Niks.Apps.Panel,getConfig:function(){return this[userConfigName]},setConfig:function(e){this[userConfigName]=e},removeUser:function(e){_.find(this.users,function(t){if(e.get(userIdField)===t.get(userIdField))return!0})||(this.users=_.without(this.users,e))},addUser:function(e){_.find(this.users,function(t){if(e.get("ObjectID")===t.get("ObjectID"))return!0})||this.users.push(e)},removeExtraUser:function(e){this.removeUser(user),this._setVotes([])},addExtraUser:function(e){this.addUser(e),this._setVotes([])},restart:function(e){this.stories=[],this.destroyPanel();var t=this.getPanel(e);return this.cardSelected=null,e&&this._doVotes(),t},loadStories:function(e){var t=this;t.getPanel().down("#cardspace")&&t.getPanel().down("#cardspace").removeAll(!1),t.stories=[],_.each(e,function(e){t._addCardToPage(e)})},_addCardToPage:function(e){var t=this.getPanel().down("#cardspace"),i=Ext.create("Niks.Apps.PokerCard",{title:Ext.String.format('<table><tr><td><a target="_blank" href={1}>{0} </a><a target="_blank" href={2} class="icon-chat"></a></td><td class="rightAlignField"><p class="rightAlignField">{3}</p></td></tr></table>',e.get(cardIdField),Rally.nav.Manager.getDetailUrl(e,{subPage:""}),Rally.nav.Manager.getDetailUrl(e,{subPage:"discussion"}),e.get("Name")),width:cardWidth,height:cardHeight});t.add(i),i.setStory(e),this.stories.push(i)},selectCard:function(e,t){var i=_.find(this.stories,function(t){return e.story.get(cardIdField)===t.story.get(cardIdField)});return i!==this.cardSelected?(i.addCls("cardSelected"),this.cardSelected&&this.cardSelected.removeCls("cardSelected"),this.cardSelected=i,this._setVoting(e,t)):(this.cardSelected.removeCls("cardSelected"),this.cardSelected=null,this._checkVoteButton(),!1)},_checkVoteButton:function(){var e=this.getPanel().down("#voteNow");e&&(this.cardSelected&&this.cardSelected.vote?e.enable():e.disable())},_setVoting:function(e,t){var i=this;this.votingCard=e,this[mainConfigName]=t;var n=this.getPanel().down("#actions");if(this.userOrModerator)return this.timerRunning?(Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Cancel current voting",message:"Stop the timer for the current session?",confirmLabel:"Yes, please",listeners:{confirm:function(){i._stopTimer(),i._configureTimer(n)},scope:i}}),!1):(this._configureTimer(n),!0);var a=_.find(this.stories,function(t){return e.story.get(cardIdField)===t.story.get(cardIdField)});a&&a.vote?i.setVote(a.vote):i.clearVote();var r=this.configPanel.down("#actions");return this.cardSelected?_.each(r.getChildItemsToDisable(),function(e){e.enable()}):(_.each(r.getChildItemsToDisable(),function(e){e.disable()}),this.getPanel().down("#votemessage").update("Choose an item &rarr;")),!0},postedVote:function(e){_.find(this.stories,function(t){return e.story.get(cardIdField)===t.story.get(cardIdField)}).postedVote()},refreshVotes:function(){this._doVotes()},addSwitch:function(){var e=this;this.getPanel().down("#menu").add({xtype:"rallybutton",width:100,text:"Switch View",margin:"10 10 0 10",handler:function(){e.app.fireEvent("switchpanel")}})},disableIterationButton:function(){this.getPanel().down("#iterationButton").disable()},enableIterationButton:function(){this.getPanel().down("#iterationButton").enable()},useTShirtSizing:function(e){this[userConfigName].useTShirt=e},setVote:function(e){var t=this;_.find(this.stories,function(e){return t.cardSelected.story.get(cardIdField)===e.story.get(cardIdField)}).setVoteString(e),this.getPanel().down("#votemessage").update("&larr; Vote "+(e.tshirt?e.size:e.value).toString()),this._checkVoteButton()},clearVote:function(){this.getPanel().down("#votemessage").update("Choose a vote &darr;"),this._checkVoteButton()},_timerRunning:0,_stopTimer:function(){this._timerRunning=0},_configureTimer:function(e){if(void 0!==this[mainConfigName]&&"00:00"!==this[mainConfigName].votingTime){var t=this[mainConfigName].votingTime.split(":");this._timerRunning=60*t[0]+t[1],this.configPanel.down("#countdowntimer").setValue(this[mainConfigName].votingTime),this.configPanel.down("#countdowntimer").getEl().removeCls("timerfinished"),this.configPanel.down("#countdowntimer").getEl().removeCls("textBlink"),this.configPanel.down("#countdowntimer").getEl().addCls("timerreset")}},_revealVotes:!1,_votes:null,_doVotes:function(){var e=this;e._getVotes().then({success:function(t){e._setVotes(t)}})},_setNameDiv:function(e){return'<div class ="votename"><b>'+e+"</b></div>"},_setCastDiv:function(e){return'<div class ="votesize"><b>'+e+"</b></div>"},_setDateDiv:function(e){return'<div class ="votedate"><b>'+e+"</b></div>"},_setVotes:function(e){if(this.configPanel){var t=this.configPanel.down("#votespanel");t.removeAll();var i=this.configPanel.down("#revealvotesbtn");!1===this._revealVotes?i.setText("Reveal Votes"):i.setText("Hide Votes"),t.add({html:this._setNameDiv("<u>Team Member</u>")}),t.add({html:this._setCastDiv("<u>Vote Cast</u>")}),t.add({html:this._setDateDiv("<u>When</u>")});var n=[];if(_.each(this.users,function(i){var a=_.find(e,function(e){return e.get("User").ObjectID===i.get("ObjectID")}),r="&nbsp",o={},s="&nbsp";void 0!==a&&(o=a.get("Text"),o=JSON.parse(o.split(pokerMsg.votePosted+":")[1].split("<")[0]),n.push(o),r=this._revealVotes?(o.tshirt?o.size+" ("+o.value+")":o.value).toString():"?",s=a.get("_CreatedAt")),t.add({html:this._setNameDiv(i.get("_refObjectName"))}),t.add({html:this._setCastDiv(r)}),t.add({html:this._setDateDiv(s)}),this.configPanel.down("#revealvotesbtn").enable()},this),this._revealVotes){t.add({html:'<div class="votestext">AVERAGE</div>'});var a=n.length,r=_.reduce(n,function(e,t,i){return{size:"uk",value:e.value+t.value}});r=r.value;var o=_.reduce(valueSeries,function(e,t,i){var n=Math.abs(e.value-r/(a||1));return Math.abs(t.value-r/(a||1))<n?t:e});t.add({html:'<div class="votestext">'+(n.length?this[userConfigName].useTShirt?o.size+" ("+o.value+")":o.value:"-")+"</div>"}),t.add({html:'<div class="votestext">'+(n.length?" ("+(r/(a||1)).toFixed(1)+")":"&nbsp")+"</div>"})}else t.add({html:'<div class="votestext">&nbsp</div>'}),t.add({html:'<div class="votestext">&nbsp</div>'}),t.add({html:'<div class="votestext">&nbsp</div>'})}},_getVotes:function(){var e=this;e._votes=null,e._revealVotes=!1;var t=Ext.create("Deft.Deferred");if(!this.cardSelected)return t.resolve([]),t.promise;var i=[];_.each(this.users,function(e){i.push({property:"User",value:e.get("_ref")})});var n=[Rally.data.wsapi.Filter.or(i)];return n.push({property:"Artifact",value:this.cardSelected.story.get("_ref")}),n.push({property:"Text",operator:"contains",value:pokerMsg.votePosted}),Ext.create("Rally.data.wsapi.Store",{model:"ConversationPost",filters:Rally.data.wsapi.Filter.and(n),autoLoad:!0,sorters:[{property:"CreationDate",direction:"DESC"}],listeners:{load:function(i,n,a){a?(e._votes=n,t.resolve(n)):t.reject()},scope:e}}),t.promise},_countdownTimer:function(e){e._timerRunning>0?(e._decrementTimer(),e.configPanel.down("#countdowntimer").getEl().addCls("timerrunning"),e.configPanel.down("#countdowntimer").getEl().removeCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().removeCls("timerreset"),e._timerRunning-=1,setTimeout(e._countdownTimer,1e3,e)):(this.cardSelected&&(e.configPanel.down("#countdowntimer").getEl().removeCls("timerrunning"),e.configPanel.down("#countdowntimer").getEl().addCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().removeCls("textBlink"),e._doVotes()),e.configPanel.down("#countdowntimer").getEl().addCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().addCls("textBlink"))},_decrementTimer:function(){var e=this.configPanel.down("#countdowntimer").getValue().split(":");if(2===e.length){var t=60*e[0]+e[1];if(0!==t){var i=t-1,n=Math.floor(i/60);n=n<10?"0"+n:n.toString();var a=i%60;a=a<10?"0"+a:a.toString(),this.configPanel.down("#countdowntimer").setValue(n+":"+a)}}},_createPanel:function(e){var t=this;this.userOrModerator=e;var i=t.configPanel=Ext.create("Ext.container.Container",{width:"100%",hideMode:"display",height:t.app.getHeight(),layout:"hbox",itemId:e?"modPage":"userPage",items:[{xtype:"container",itemId:"menu",width:120,margin:cardMargin,cls:"clearpanel"},{xtype:"container",itemId:"actions",width:400,cls:"clearpanel"},{xtype:"container",itemId:"cardspaceparent",width:"50%",height:"100%",flex:1,cls:"clearpanel",autoScroll:!0}]});if(e)i.down("#actions").add({xtype:"container",margin:"10 0 0 0",cls:"userpanel",items:[{xtype:"textfield",itemId:"countdowntimer",height:50,margin:10,labelCls:"cardtext",fieldCls:"clearpanel timertext timerreset",fieldLabel:"Countdown Timer",labelAlign:"left",value:"00:00",readOnly:!0,labelWidth:120},{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",text:"Start",margin:10,width:100,handler:function(){null===this.cardSelected?Rally.ui.notify.Notifier.showWarning({message:"No story selected"}):t._countdownTimer(t)}},{xtype:"rallybutton",text:"Stop",margin:10,width:100,handler:function(){t._timerRunning=0}},{xtype:"rallybutton",text:"Reset",width:100,margin:10,handler:function(){t._configureTimer()}}]},{xtype:"panel",itemId:"votespanel",width:"100%",bodyCls:"userpanel",layout:{type:"table",columns:3,tdAttrs:{style:{textAlign:"center"}}},defaults:{bodyStyle:"border:none"}},{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",text:"Refresh Votes",margin:10,width:100,handler:function(){t._doVotes()}},{xtype:"rallybutton",itemId:"revealvotesbtn",text:"Reveal Votes",margin:10,width:100,disabled:!0,handler:function(){t._revealVotes=!t._revealVotes,t._setVotes(t._votes)}},{xtype:"rallybutton",margin:10,width:100,text:"Delete Votes",handler:function(){t.app.fireEvent("removeGame")}}]}]});else{i.down("#actions").add({xtype:"label",itemId:"votemessage",grow:!0,margin:10,hideLabel:!0,readOnly:!0,html:"Choose an item &rarr; ",cls:"clearpanel timertext"});var n=Ext.create("Ext.panel.Panel",{xtype:"panel",itemId:"sizespace",margin:10,layout:{type:"table",columns:2},bodyCls:"userpanel"});i.down("#actions").add(n),_.each(valueSeries,function(e){var i=Ext.create("Niks.Apps.PokerCard",{width:150,height:80});n.add(i),e.tshirt=t[userConfigName].useTShirt,i.setVoteSize(e)})}t.app.add(i);var a=i.down("#cardspaceparent");a.removeCls("x-panel-body-default");var r=Math.floor(a.getWidth()/(cardWidth+2*cardMargin));return r=r>0?r:1,a.add({xtype:"panel",itemId:"cardspace",margin:10,layout:{type:"table",columns:r},bodyCls:"userpanel"}),this.userOrModerator?(i.down("#menu").add({xtype:"rallybutton",width:100,text:"Config",margin:"10 10 0 10",handler:function(){t.app.fireEvent("showConfig")}}),i.down("#menu").add({xtype:"rallybutton",itemId:"iterationButton",width:100,text:"Iteration",margin:"10 10 0 10",handler:function(){t.app.fireEvent("changeIteration")}})):i.down("#menu").add({xtype:"rallybutton",width:100,disabled:!0,itemId:"voteNow",text:"Vote Now",margin:"10 10 0 10",handler:function(){t.app.fireEvent("postvote")}}),i.down("#menu").add({xtype:"rallybutton",width:100,text:"Reload Game",margin:"10 10 0 10",handler:function(){t.app.fireEvent("refresh")}}),i}});
                Ext.define("Niks.Apps.PokerIterationConfig",{extend:Niks.Apps.Panel,id:iterConfigName+"Panel",constructor:function(){this.callParent(arguments),this[iterConfigName]={currentIteration:null}},getConfig:function(){return this[iterConfigName]},setConfig:function(e){Ext.merge(this[iterConfigName],e)},_createPanel:function(){var e=this,t=Ext.create("Ext.panel.Panel",{floating:!0,draggable:!0,width:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return e.getCurrentIteration().then({success:function(r){t.add({xtype:"rallyiterationcombobox",margin:40,hideTrigger:!0,store:e._iterationStore,storeConfig:{autoLoad:!1},value:r,listeners:{select:function(t,r){Array.isArray(r)?e[iterConfigName].currentIteration=r[0].get("_ref"):e[iterConfigName].currentIteration=r.get("_ref"),e.app.fireEvent(configChange)}}})}}),e.configPanel=t,t},getCurrentIteration:function(){var e=this;if(this[iterConfigName].currentIteration){var t=Ext.create("Deft.Deferred");return e._iterationStore?t.resolve(e[iterConfigName].currentIteration):e._getIterations(!1).then({success:function(){t.resolve(e[iterConfigName].currentIteration)}}),t.promise}return this._getIterations(!0)},_getIterations:function(e){var t=this,r=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("Iteration"),autoLoad:!0,context:t.app.getContext().getDataContext(),fetch:["Name","StartDate","EndDate","ObjectID","State","PlannedVelocity"],filters:[{property:"EndDate",operator:">",value:new Date}],sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(n,i,a){a?(t._iterationStore=n,e&&n.totalCount&&(t[iterConfigName].currentIteration=n.getAt(0).get("_ref")),r.resolve(t[iterConfigName].currentIteration)):(Rally.ui.notify.Notifier.showWarning({message:"No appropriate Iterations available"}),r.reject())}}}),r.promise}});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .userpanel{border-left:1px solid black;border-top:none;border-right:1px solid black;border-bottom:none;background-color:whitesmoke}.clearpanel{border:none}.configPanel{opacity:1;background-color:palegoldenrod}.definedfield{border-style:none none solid none;border-color:black;border-width:1px}.erroredfield{border-style:none none solid none;border-color:red;border-width:1px}.timertext{font-size:36px}.timerrunning{background-color:teal}.timerfinished{background-color:tomato}.timerreset{background-color:white}.cardtext{color:black;font-size:12px;margin-left:5px}.cardSelected{border:3px #00a9e0 solid}.rightAlignField{text-align:right;width:60%;flex:auto}@keyframes textBlink{50%{opacity:0.5}}@-webkit-keyframes textBlink{50%{opacity:0.5}}.textBlink{animation:textBlink 1s step-start 0s infinite;-webkit-animation:textBlink 1s step-start 0s infinite}.votesize{color:black;width:100px;height:30px}.votedate{color:black;width:140px;height:30px}.votename{color:black;width:160px;height:30px}.buttonpushed{color:#78bee0}.votestext{font-size:24px;text-align:'center';border-style:solid none none none;border-color:lightgrey;border-width:2px}
    </style>
</head>
<body>
</body>
</html>
